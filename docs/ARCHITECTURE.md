# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ ¬´–ë–ê–ó–ó–ï–†¬ª

–î–æ–∫—É–º–µ–Ω—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –∏ –∫–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è.

---

## 1. –û–±—â–∞—è —Å—Ö–µ–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïñ
‚îÇ Telegram API ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   Aiogram    ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ Handlers     ‚ïë
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïú
                                                        ‚îÇ
                                                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                                ‚îÇ Services       ‚îÇ
                                                ‚îÇ (game_service, ‚îÇ
                                                ‚îÇ  game_state)   ‚îÇ
                                                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                       ‚îÇ
                                            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                            ‚îÇ SQLAlchemy ORM / DB ‚îÇ
                                            ‚îÇ (async engine)      ‚îÇ
                                            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

- **Handlers**: —Ä–µ–∞–≥–∏—Ä—É—é—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã –∏ callback‚Äô–∏, –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∫ —Å–µ—Ä–≤–∏—Å–∞–º.
- **Services**: —á–∏—Å—Ç–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤, —Ä–∞–±–æ—Ç–∞ —Å –æ—á–µ—Ä–µ–¥—å—é.
- **DB/ORM**: —Ö—Ä–∞–Ω–∏—Ç –∫–æ–º–∞–Ω–¥—ã, —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∏–≥—Ä—ã, —Ä–∞—É–Ω–¥—ã; –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ ORM (`select(Model)`).
- **game_state**: in-memory —Å–ª–æ–≤–∞—Ä—å `STATE[chat_id]`, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—â–∏–π –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –æ—á–µ—Ä–µ–¥—å –≤–Ω—É—Ç—Ä–∏ —á–∞—Ç–∞.

---

## 2. –ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å

| –ü–∞–ø–∫–∞/–º–æ–¥—É–ª—å             | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å                                   |
|--------------------------|---------------------------------------------------|
| `quizbot/__main__.py`    | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–æ–≤, init –ë–î, –∑–∞–ø—É—Å–∫ polling          |
| `quizbot/config.py`      | Pydantic Settings, —á—Ç–µ–Ω–∏–µ `.env`                  |
| `quizbot/db.py`          | Async engine, session factory, PRAGMA –¥–ª—è SQLite  |
| `quizbot/models.py`      | ORM-–º–æ–¥–µ–ª–∏ (Teams, Members, Games, Rounds)        |
| `quizbot/services/`      | –û—á–µ—Ä–µ–¥—å –≤ –ø–∞–º—è—Ç–∏ (`game_state`) + –ª–æ–≥–∏–∫–∞ (`game_service`) |
| `quizbot/handlers/`      | Aiogram-—Ä–æ—É—Ç–µ—Ä—ã: –∫–æ–º–∞–Ω–¥—ã –∏ –∫–Ω–æ–ø–∫–∏                 |
| `quizbot/keyboards.py`   | –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã (—Å–µ–π—á–∞—Å –æ–¥–Ω–∞)                          |
| `quizbot/utils.py`       | –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏                           |
| `tests/`                 | –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π (handlers, services, –∫–æ–Ω—Ñ–∏–≥‚Ä¶) |

---

## 3. –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∞—è –æ—á–µ—Ä–µ–¥—å

```python
STATE: Dict[int, GameState] = {}

@dataclass
class GameState:
    queue: List[int]
    lock: asyncio.Lock
```

- –ö–∞–∂–¥—ã–π —á–∞—Ç –∏–º–µ–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π `GameState`.
- `press_buzzer` –±–µ—Ä—ë—Ç `asyncio.Lock`, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –≥–æ–Ω–æ–∫ –ø—Ä–∏ –º–∞—Å—Å–æ–≤—ã—Ö –Ω–∞–∂–∞—Ç–∏—è—Ö.
- –û—á–µ—Ä–µ–¥—å —Ö—Ä–∞–Ω–∏—Ç **—Ç–æ–ª—å–∫–æ ID –∫–æ–º–∞–Ω–¥** ‚Üí –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä—ë–º –∏ –±—ã—Å—Ç—Ä–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è.

---

## 4. –°—Ç–∞—Ç—É—Å—ã –∏–≥—Ä—ã

`Game.status` –º–æ–∂–µ—Ç –±—ã—Ç—å:
- `idle` ‚Äî —Å–æ–∑–¥–∞–Ω–∞, –Ω–æ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞ (–ø–æ—Å–ª–µ `/new_game`).
- `running` ‚Äî –∞–∫—Ç–∏–≤–Ω—ã–π —Ä–∞—É–Ω–¥ (–ø–æ—Å–ª–µ `/start_game`).
- `finished` ‚Äî –∑–∞–∫—Ä—ã—Ç–∞ (`/finish_game` –∏–ª–∏ `/new_game` –ø–æ–≤–µ—Ä—Ö —Å—Ç–∞—Ä–æ–π).

–°–µ—Ä–≤–∏—Å `press_buzzer` –¥–æ–ø—É—Å–∫–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —Å—Ç–∞—Ç—É—Å `running`.

---

## 5. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ

- **–ù–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞** ‚Üí –¥–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ `handlers/commands.py` –∏ –ª–æ–≥–∏–∫—É –≤ `services/`.
- **–û—Ç—á—ë—Ç—ã/—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** ‚Üí —Å–æ–∑–¥–∞–π—Ç–µ –º–æ–¥–µ–ª—å, –º–∏–≥—Ä–∞—Ü–∏—é (–∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –≤ SQLite) –∏ –∑–∞–ø–æ–ª–Ω—è–π—Ç–µ –µ—ë –≤ –Ω—É–∂–Ω—ã—Ö —Ö—ç–Ω–¥–ª–µ—Ä–∞—Ö.
- **–î—Ä—É–≥–∞—è –ë–î** ‚Üí –ø–æ–º–µ–Ω—è–π—Ç–µ `DATABASE_URL`, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥—Ä–∞–π–≤–µ—Ä (`asyncpg` –¥–ª—è PostgreSQL) –∏, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏.
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Redis** ‚Üí –≤—ã–Ω–µ—Å–∏—Ç–µ `STATE` –≤ Redis, –∑–∞–º–µ–Ω–∏–≤ `game_state` –Ω–∞ –∫–ª–∞—Å—Å —Å —Ç–µ–º–∏ –∂–µ –º–µ—Ç–æ–¥–∞–º–∏ (`get_state`, `reset_round`).

---

## 6. –ü–æ—Ç–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

1. **–ö–æ–º–∞–Ω–¥–∞ `/register_team`**  
   Handler ‚Üí Service (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è) ‚Üí ORM (—Å–æ–∑–¥–∞–Ω–∏–µ Team/Member) ‚Üí commit.
2. **–ù–∞–∂–∞—Ç–∏–µ ¬´–ë–ê–ó–ó–ï–†¬ª**  
   Handler ‚Üí Service `press_buzzer` ‚Üí –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (`Game.status`, –Ω–∞–ª–∏—á–∏–µ –∫–æ–º–∞–Ω–¥—ã) ‚Üí Lock ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ ‚Üí –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –≤ —á–∞—Ç.
3. **`/wrong`**  
   Handler ‚Üí Service `pop_next` ‚Üí Lock ‚Üí –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å ‚Üí —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ.

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ; —Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `async with SessionLocal()`.

---

## 7. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- **Unit**: –ü—Ä–æ–≤–µ—Ä—è—é—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ —Ö—ç–Ω–¥–ª–µ—Ä—ã —á–µ—Ä–µ–∑ —Ñ–∏–∫—Å—Ç—É—Ä—ã (—Å–º. `tests/`).
- **DB**: `tests/conftest.py` —Å–æ–∑–¥–∞—ë—Ç in-memory SQLite —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º –¥–≤–∏–∂–∫–æ–º –Ω–∞ —Ç–µ—Å—Ç –∏ —á–∏—Å—Ç–∏—Ç `STATE`.
- **Coverage** ~93% (handlers, services, config, DB init, main).

---

## 8. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- In-memory –æ—á–µ—Ä–µ–¥—å –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –º–∞–ª—ã—Ö –∏ —Å—Ä–µ–¥–Ω–∏—Ö —á–∞—Ç–æ–≤. –î–ª—è –±–æ–ª—å—à–∏—Ö (—Ç—ã—Å—è—á–∏ –∫–æ–º–∞–Ω–¥) —Å—Ç–æ–∏—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.
- SQLite –æ—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è MVP. –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ PostgreSQL –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É (Redis).

---

## 9. TODO / –∏–¥–µ–∏ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è

- –ò—Å—Ç–æ—Ä–∏—è –ø–æ–±–µ–¥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º.
- –¢–∞–π–º–µ—Ä –Ω–∞ –æ—Ç–≤–µ—Ç –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É.
- Web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤–µ–¥—É—â–µ–≥–æ —Å live-–æ—á–µ—Ä–µ–¥—å—é.
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö —Ä–∞—É–Ω–¥–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ —á–∞—Ç–∞.

---

–ì–æ—Ç–æ–≤–æ. –≠—Ç—É –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å –∏ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞—Ç—å: –≤—Å–µ —Å–ª–æ–∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã, —Ç–µ—Å—Ç—ã –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö, –∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª–µ–π –ø–æ–≤—Ç–æ—Ä—è–µ—Ç ¬´—á–∏—Å—Ç—É—é¬ª –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é —Å–µ—Ä–≤–∏—Å–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤. –£–¥–∞—á–∏ –≤ —Ä–∞–∑–≤–∏—Ç–∏–∏! üöÄ
