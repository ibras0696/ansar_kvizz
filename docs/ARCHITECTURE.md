# ะััะธัะตะบัััะฐ ยซะะะะะะยป (v2)

---

## 1. ะะฑัะฐั ััะตะผะฐ
```
โโโโโโโโโโโโโโโโ        โโโโโโโโโโโโโโโโ        โโโโโโโโโโโโโโโโโ
โ Telegram API โโโโโโโโโบโ   Aiogram    โโโโโโโโโบโ Handlers      โ
โโโโโโโโโโโโโโโโ        โโโโโโโโโโโโโโโโ        โโโโโโโโฌโโโโโโโโโ
                                                       โ
                                               โโโโโโโโโผโโโโโโโโโ
                                               โ Services       โ
                                               โ (game_service, โ
                                               โ  game_state)   โ
                                               โโโโโโโโโฌโโโโโโโโโ
                                                       โ
                                           โโโโโโโโโโโโโผโโโโโโโโโโโโ
                                           โ SQLAlchemy ORM / DB   โ
                                           โ (async engine SQLite) โ
                                           โโโโโโโโโโโโโโโโโโโโโโโโโ
```

- <b>handlers.commands</b> โ `/start`, `/help`, ะพะฑัะฐะฑะพัะบะฐ ัะตะบััะพะฒะพะณะพ ะฒะฒะพะดะฐ ะฝะฐะทะฒะฐะฝะธั.
- <b>handlers.callbacks</b> โ ะฒะตัั ะธะฝัะตัะฐะบัะธะฒ: ัะตะณะธัััะฐัะธั, ยซะะะะะะยป, ะฐะดะผะธะฝ-ะฟะฐะฝะตะปั.
- <b>services.game_service</b> โ ะฑะธะทะฝะตั-ะปะพะณะธะบะฐ (ะธะณัะพะบะธ, ะบะพะผะฐะฝะดั, ะธะณัะฐ, ััะตะผะฐ ะพัะบะพะฒ, ะพัะตัะตะดั).
- <b>services.game_state</b> โ in-memory ะพัะตัะตะดั per `game_id` (ะธัะฟะพะปัะทัะตััั ัะพะปัะบะพ ะฒะพ ะฒัะตะผั ะฒะพะฟัะพัะฐ).
- <b>models</b> โ Player โ Team (ัะตัะตะท TeamMember) + Game + GameParticipant (ัััั).

---

## 2. ะะพะดะตะปั ะดะฐะฝะฝัั
- `players` โ ะฒัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ, ะบะพะณะดะฐ-ะปะธะฑะพ ะฝะฐะฟะธัะฐะฒัะธะต ะฑะพัั (Telegram ID, username, ะธะผั).
- `teams` โ ัะฝะธะบะฐะปัะฝัะต ะฝะฐะทะฒะฐะฝะธั ะบะพะผะฐะฝะด.
- `team_members` โ ัะฒัะทั ะธะณัะพะบ โ ะบะพะผะฐะฝะดะฐ (ะพะดะธะฝ ะธะณัะพะบ = ะพะดะฝะฐ ะบะพะผะฐะฝะดะฐ).
- `games` โ ะธะณัะฐ, ะทะฐะฟััะตะฝะฝะฐั ะฐะดะผะธะฝะธัััะฐัะพัะพะผ (`status` โ {`idle`, `running`, `question`, `finished`}).
- `game_participants` โ ัััั ะบะพะผะฐะฝะดั ะฒ ัะฐะผะบะฐั ะธะณัั.

ะ ะพะดะฝะพะน ะฑะฐะทะต ััะฐะฝะธััั ะธััะพัะธั ะธะณั; ะฟัะธ ะทะฐะฟััะบะต ะฝะพะฒะพะน ะธะณัั ะดะพะฑะฐะฒะปัะตััั ะทะฐะฟะธัั ะฒ `games`, ะฟัะตะดัะดััะฐั (ะตัะปะธ ะฑัะปะฐ) ะฟะตัะตะฒะพะดะธััั ะฒ `finished`.

---

## 3. ะกะพััะพัะฝะธั ะธะณัั
- `idle` โ ัะพะทะดะฐะฝะฐ, ะฝะพ ะตัั ะฝะต ะทะฐะฟััะตะฝะฐ.
- `running` โ ะธะณัะฐ ะธะดัั, ะฒะพะฟัะพั ะฝะต ะฐะบัะธะฒะตะฝ.
- `question` โ ะพัะบััั ะฒะพะฟัะพั, ะธะณัะพะบะธ ะผะพะณัั ะถะฐัั ยซะะะะะะยป (ะพัะตัะตะดั ะฐะบัะธะฒะฝะฐ).
- `finished` โ ะธะณัะฐ ะทะฐะฒะตััะตะฝะฐ, ะพัะตัะตะดั ะพัะธัะตะฝะฐ, ะพัะบะธ ะดะพัััะฟะฝั ะฒ ัะฐะฑะปะธัะต.

ะะตัะตัะพะดั:
1. `/start` ะฐะดะผะธะฝะฐ โ `idle` (ัะพะทะดะฐัััั ะทะฐะฟะธัั).
2. ะะฝะพะฟะบะฐ ยซ๐ ะะฐะฟัััะธัั ะธะณััยป โ `running` + ัะฐัััะปะบะฐ ยซะณะพัะพะฒััะตััยป.
3. ยซโ ะะฐะฟัััะธัั ะฒะพะฟัะพัยป โ `question` + ัะฐัััะปะบะฐ ยซะะะะะะยป.
4. ยซโ ะะตัะฝะพยป โ `running` (ะพัะตัะตะดั ะพัะธัะตะฝะฐ, ะฑะฐะปะป ะฝะฐัะธัะปะตะฝ).
5. ยซโ ะะตะฒะตัะฝะพยป โ ะพััะฐัััั `question`, ะฟะพะบะฐ ะพัะตัะตะดั ะฝะต ะพะฟัััะตะตั; ะทะฐัะตะผ `running`.
6. ยซ๐ ะะฐะฒะตััะธัั ะธะณััยป โ `finished`.

---

## 4. ะัะตัะตะดั
- ะฅัะฐะฝะธััั ะฒ `STATE[game_id]`, ััััะบัััะฐ `Queue[int]` (team_id).
- ะะพัััะฟ ะทะฐัะธััะฝ `asyncio.Lock` โ ะฒัะต ะพะฟะตัะฐัะธะธ (`press_buzzer`, `pop_queue`, `current_queue`).
- ะะฐ ััะฐััะต ะฒะพะฟัะพัะฐ `reset_round(game_id)` ะพัะธัะฐะตั ะพัะตัะตะดั.
- ะะพัะปะต ยซะะตัะฝะพยป ะฒัะทัะฒะฐะตััั `finish_question`, ััะพ ัะฐะบะถะต ัะฑัะฐััะฒะฐะตั ะพัะตัะตะดั.

---

## 5. ะัะบะธ
- `award_score` ะดะพะฑะฐะฒะปัะตั ะฑะฐะปะปั ะทะฐะฟะธัะธ `GameParticipant`.
- ะขะฐะฑะปะธัะฐ ัััะพะธััั ัะตัะตะท `get_scores` (JOIN `game_participants` + `teams`).
- ะัะธ ะดะพะฑะฐะฒะปะตะฝะธะธ ะฝะพะฒัั ะบะพะผะฐะฝะด ะฒ ะฟัะพัะตััะต ะธะณัั `ensure_participants` ัะพะทะดะฐัั ะทะฐะฟะธัะธ ะดะปั ะฝะธั.

---

## 6. ะะทะพะปััะธั ะปะพะณะธะบะธ
- <b>game_service</b> โ ะฝะต ะธัะฟะพะปัะทัะตั Aiogram; ัะดะพะฑะฝะพ ะฟะพะบััะฒะฐัั ัะตััะฐะผะธ.
- <b>callbacks</b> โ ะผะฐะบัะธะผัะผ ยซะบะปะตะนยป ะผะตะถะดั ัะตัะฒะธัะฐะผะธ ะธ Telegram API (ัะฐัััะปะบะฐ ัะพะพะฑัะตะฝะธะน, ะฟะพัััะพะตะฝะธะต ะบะปะฐะฒะธะฐััั).
- <b>registration_state</b> โ ะผะธะฝะธะผะฐะปัะฝะพะต ัะพััะพัะฝะธะต ะดะปั ะพะถะธะดะฐะฝะธั ะฝะฐะทะฒะฐะฝะธั ะบะพะผะฐะฝะดั (ะฒะผะตััะพ FSM).

---

## 7. ะะฐััะธัะตะฝะธะต
- <b>ะะตัะบะพะปัะบะพ ะธะณั</b>: ัะตะบััะฐั ะผะพะดะตะปั ะฟัะตะดะฟะพะปะฐะณะฐะตั ะพะดะฝั ะฐะบัะธะฒะฝัั ะธะณัั. ะะปั ะผัะปััะธะธะณัะพะฒะพะณะพ ัะตะถะธะผะฐ ะดะพะฑะฐะฒััะต ะฟะพะปะต ยซchannelยป ะธะปะธ ยซcontextยป ะฒ `Game` ะธ ะฟัะพะบะธะฝััะต ะตะณะพ ะฒ `STATE`.
- <b>ะััะณะธะต ะพัะบะธ</b>: ะธะทะผะตะฝะธัะต `points` ะฒ `award_score` ะธะปะธ ะฟะตัะตะดะฐะฒะฐะนัะต ัะฐะทะฝัะต ะทะฝะฐัะตะฝะธั ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ะฒะพะฟัะพัะฐ.
- <b>ะะตััะธััะตะฝัะฝะฐั ะพัะตัะตะดั</b>: ะทะฐะผะตะฝะธัะต `game_state` ะฝะฐ Redis, ัะพััะฐะฝะธะฒ API `get_state/reset_round`.

---

## 8. ะะพัะตะฝัะธะฐะปัะฝัะต ะดะพัะฐะฑะพัะบะธ
- ะััะพะด ะธะท ะบะพะผะฐะฝะดั / ัะผะตะฝะฐ ะฝะฐะทะฒะฐะฝะธั.
- ะัะฑะพั ะบะพะปะธัะตััะฒะฐ ะฑะฐะปะปะพะฒ ัะตัะตะท ะพัะดะตะปัะฝัะต ะบะฝะพะฟะบะธ.
- ะะฝัะตะณัะฐัะธั ั ะฒะฝะตัะฝะธะผะธ ะผะตััะตะฝะดะถะตัะฐะผะธ (Slack/Discord) ัะตัะตะท ะดะพะฟะพะปะฝะธัะตะปัะฝัะน ัะปะพะน ะฒ `callbacks`.

ะััะธัะตะบัััะฐ ัะพััะฐะฝัะตั ัะธััะพะต ัะฐะทะดะตะปะตะฝะธะต: ะดะฐะฝะฝัะต โ ัะตัะฒะธัั โ Telegram. ะญัะพ ัะฟัะพัะฐะตั ัะตััะธัะพะฒะฐะฝะธะต ะธ ะดะฐะปัะฝะตะนัะตะต ัะฐะทะฒะธัะธะต.
